head	1.13;
access;
symbols;
locks; strict;
comment	@# @;


1.13
date	2023.05.03.14.23.51;	author u0_a111;	state Exp;
branches;
next	1.12;
commitid	10064526E77597FDD2F;

1.12
date	2023.05.02.15.59.12;	author u0_a111;	state Exp;
branches;
next	1.11;
commitid	100645133507C7701BA;

1.11
date	2023.05.02.15.01.44;	author u0_a111;	state Exp;
branches;
next	1.10;
commitid	100645125D876670A98;

1.10
date	2023.05.02.09.16.59;	author u0_a111;	state Exp;
branches;
next	1.9;
commitid	1006450D50B4B37CD19;

1.9
date	2023.01.29.07.49.26;	author u0_a111;	state Exp;
branches;
next	1.8;
commitid	10063D625065F4D0AA5;

1.8
date	2023.01.28.05.52.58;	author u0_a111;	state Exp;
branches;
next	1.7;
commitid	10063D4B83A0B52C6E5;

1.7
date	2023.01.28.05.29.31;	author u0_a111;	state Exp;
branches;
next	1.6;
commitid	10063D4B2BB08E56A0C;

1.6
date	2023.01.27.13.19.05;	author u0_a111;	state Exp;
branches;
next	1.5;
commitid	10063D3CF495F9E307A;

1.5
date	2023.01.27.12.25.21;	author u0_a111;	state Exp;
branches;
next	1.4;
commitid	10063D3C2B1597CE4F9;

1.4
date	2023.01.26.13.23.29;	author u0_a111;	state Exp;
branches;
next	1.3;
commitid	10063D27ED14EB3E074;

1.3
date	2023.01.21.15.21.57;	author u0_a111;	state Exp;
branches;
next	1.2;
commitid	10063CC03153D6350D5;

1.2
date	2023.01.15.06.01.26;	author u0_a111;	state Exp;
branches;
next	1.1;
commitid	10063C396B61EBD70B7;

1.1
date	2023.01.10.23.58.56;	author u0_a111;	state Exp;
branches;
next	;
commitid	10063BDFBC021F2E81B;


desc
@@


1.13
log
@fix: change search keyword to pyde.cgi
@
text
@/// Global variable declare
var g_date = 0
function viewGDate(){var d = document.getElementById("gdate");d.innerHTML=g_date}

/// d0/t0->12 d1/t1->18 d2/t2->24
/// success return 12/18/24 fail return false
function tag2hour(str){
  var idx = parseInt(str.substring(1));
  var ret = false;
  if (0<=idx && idx<=2) {
    ret = 12+idx*6
  }
  return ret
}

/// check date is like 180210, ajust 6 digit
/// return true date OK / false date wrong
function checkDate(day){
  return day.length==6;
}

/// use Base64 to convert multiword into ASCII, so Droid can send
function dropnl_encb64(str){
  var can_out = str.replace(/\n/g, "")
  str = (Base64.encode(can_out)); // = is still =, but http will drop it, avoid this bug on server
  return str;
}

function trimFirstLF(str){
  var needStr = str;
  if (str.charAt(0) == "\n" || str.charAt(0) == " ") {
    needStr = str.slice(1);
  }
  return needStr
}

////////////////////////////
/// callback for http ajax
function HandleHint(error, response){
  showHint(response);
}

function HandleShowLong(error, response){
  showHint(response, 2);
}

function HandleEditTm( error, response ) {
  var txt = document.getElementById("eNow");
  // tmrec startwith "221001|", so skip leader char
  txt.value = trimFirstLF(response).substring(7)
}

function HandleEditBlog(error, response) {
  var txt = document.getElementById("eNow");
  response = trimFirstLF(response)
  var st = response.indexOf('|')
  var tag = response.slice(0, st);
  var etg = document.getElementById("eBtg");
  etg.value = tag;
  var ctx = response.slice(st+1);
  txt.value = ctx
  //also preview in div
  setDivShow("eDone", marked.parse(ctx));
}

function HandleDone( error, response ){
  setDivShow("eDone", trimFirstLF(response));
}

function HandleMD(error, response){
  setDivShow("eDone", marked.parse(response));
}

function HandleStdout(error, response){
  var can_out = response.replace(/\n/g, "<br />")
  setDivShow("eDone", can_out);
}

function HandleBlst(error, response){
  var can_out = response.replace(/\n/g, "<br />")
  setDivShow("eBlst", can_out);
}

function HandleUpPic(error, response){
  showHint(response, 1)
}
/////////////////////////////////////////
/// button callback function

/// return [0]-pub or priv [1]-blog or tmrec
function sepraDB(){
  var edb = getElemValue("eDb");
  return edb.split('-');
}

/// get tmrec text
function onEdit(eYear, eMonth, eTb){
  var fdb = sepraDB();
  var day = getElemValue("eNow");
  if (fdb[1]=='tmrec') {
    if (checkDate(day)) { g_date = day; viewGDate() } else {day=curDay()}
    var req = "/tmrec.cgi/read?db="+fdb[0]+"&dt="+(day);
    httpGet(req, HandleEditTm);
  }else if(fdb[1]=='blog'){
    if ( !checkDate(day) ) {
      showHint('Your input day is illegal!');
      return;
    }
    g_date = day; viewGDate();// next upload use this day
    httpPost("/tmrec.cgi/blread?dt="+day+"&n=0", 'dt='+day,
      HandleEditBlog);
  }
}

///\param[in] fdb DB name
///\param[in] day which day to save
function uploadRec(fdb, day){
  var hour = getElemValue("eTag");
  hour = tag2hour(hour)
  var rec = getElemValue("eNow");
  var pct = {hour:hour,txt:(dropnl_encb64(rec)),db:fdb,dt:day};
  httpPost("/pyde.cgi/art/tmupload", pct, HandleDone );
}

function uploadBlog(fdb, day) {
  var txt = getElemValue("eNow");
  var tag = getElemValue("eBtg");
  var pct = "tag="+tag+"|ctx="+ Base64.encode(txt);
  httpPost("/tmrec.cgi/bledit?dt="+day, pct, HandleHint );
}

function previewMd(src, dst){
  setDivShow(dst, marked.parse(getElemValue(src)));
}

/// upload blog and tmrec
function onUpload(){
  var er = sepraDB();
  var day = g_date==0 ? curDay() : g_date;
  if (er[1]=='tmrec') {
    uploadRec(er[0], day);
  } else if(er[1]=='blog') {
    // save to another day, avoid of overwrite
    var rep = getElemValue('eDay');
    if (rep<10){
      var day = day.replace(/\d$/, rep);
      if (g_date) {
        day = g_date;  // use last date
      }
      if ( confirm("upload blog "+er[0]+day) ){
        uploadBlog(er[0], day);
        previewMd('eNow', 'eDone');
      }
    } else{
      showHint('Choose day is exceed 10!');
    }
  }
}

/// local db
function getDB() {
  var tag = getElemValue("eTag");
  var txt = document.getElementById("eNow");
  var tmp = app.LoadText( tag, "" );
  txt.value = tmp;
}

function setDB() {
  var tag = getElemValue("eTag");
  var txt = getElemValue("eNow");
  app.SaveText( tag, txt );
  showHint("SETLOCAL OK!");
}

// get recent blog date-title or some month tmrec
function onRecent() {
  var fdb = sepraDB();
  if(fdb[1]=='blog'){
    var page = parseInt(getElemValue("eNow"));
    if (!page || page > 20) { //TODO limit page
      page = 0;
    }
    var tag = getElemValue("eBtg");
    // default get recent some blog
    if (tag == "unknown" ) {
      httpPost("/tmrec.cgi/title?page="+page, '', HandleBlst);
    } else { // otherwise get specify tag blog
      httpPost("/digest/tagBlog/"+fdb[0]+"/"+tag, '', HandleBlst);
    }
  }else if(fdb[1]=='tmrec') {
    var yearmon = parseInt(getElemValue("eNow"));
    if (yearmon && yearmon >1000 && yearmon < 9999) {
      yearmon += '';
    } else {
      var mon = curDay();
      var year = mon.substring(0, 2);// trieve year
      var curmon = mon.substring(2, 4);//trieve month
      mon = getElemValue("eDay");
      if (mon<10){
        mon = '0'+mon;
      }
      if (mon>curmon) {//over current month, get last year
        year--; year += '';
      }
      yearmon = year + mon;
    }
    httpPost("/tmrec.cgi/read?db="+fdb[0]+"&dt="+yearmon, '', HandleStdout);
  }
}

function removeDay(){
  var day = getElemValue("eNow");
  if ( !checkDate(day) ) {
    showHint('Your input day is illegal!');
    return;
  }
  var fdb = sepraDB();
  var iswant = confirm(`Do you really want to delete ${fdb[0]}-${fdb[1]} ${day}`);
  if (iswant) {
    httpGet(`/pyde.cgi/art/removeDay?db=${fdb[0]}&tbl=${fdb[1]}&dt=${day}`,
      HandleShowLong);
  }
}

/// find keyword (deprecate page)
function queryBlogTmKwd(page) {
  var kwd = getElemValue("eNow");
  httpGet("/pyde.cgi/art/any_kwd?kwd="+dropnl_encb64(kwd), HandleStdout);
}

function clearContent() {
  var txt = document.getElementById("eNow");
  txt.value = '';
  g_date = 0; viewGDate()
}

// to: deprecated, now random view
function viewBlog(to) {
  var fdb = sepraDB();
  var off = parseInt(getElemValue("eDay"));
  if (to=='m') { off = 0-off; }
  else if (to=='s') { off = 10*off; } //skip 10 times
  httpGet("/tmrec.cgi/blrand?db="+fdb[0]+"&tbl="+fdb[1]+"&n=0",
      HandleMD);
}

function exitView() {
    $("#eP1").show();
    $("#eP2").hide();
}

//Called when user touches our button.
function uploadFile( elemFile, upName ) {
  var f = document.getElementById(elemFile).files[0];
  var extName = f.name.replace(/.*\./, '');
  var fn = getElemValue(upName);
  if (fn == '') {alert("must input file name!"); return;}
  var reader = new FileReader();
  reader.readAsDataURL(f);
  reader.onload = function(e){
    var pic = this.result;
    var param = {pic:pic, ext:extName, fn:fn}
    httpPost("/upload.php", param, HandleUpPic)
  }
}

function onMenu( ) {
    var m = document.getElementById("eMenu");
    var item = m.value;
  /// enter menu, item is undefined, use if to ban it
  if (item=="PASTE") {
    var cp = app.GetClipboardText();
    var txt = document.getElementById("eNow");
    txt.value += cp;
  } else if (item=="QUERYKEY") {
    queryBlogTmKwd(0);
  } else if(item=="PREVIEW"){
    var txt = marked.parse(getElemValue("eNow"));
    setDivShow("eDone", txt);
  } else if(item=="CLEAR"){
    clearContent();
  } else if (item=="VIEW") {
    $("#eP2").show();
    $("#eP1").hide();
  } else if (item=="DELETE") {
    removeDay();
  }
  m.value = "MENU";
}

function start_show(){
  httpPost("/startup.cgi", '', HandleDone );
}
@


1.12
log
@feat: show gdate on tmrec
@
text
@d228 1
a228 1
  httpGet("/tmrec.cgi/keyword?kwd="+dropnl_encb64(kwd)+"&n=0", HandleStdout);
@


1.11
log
@feat: change font
@
text
@d3 1
a3 1
var g_off=0;
d101 2
a102 1
    var req = "/tmrec.cgi/read?db="+fdb[0]+"&dt="+(checkDate(day)?day:curDay());
d109 1
a109 1
    g_date = day; // next upload use this day
d139 1
a139 1
  var day = curDay();
d234 1
a234 1
  g_date = 0;
a242 1
  g_off += off;
@


1.10
log
@fix: let random view outside and survive delete
@
text
@d25 1
a25 1
  str = Base64.encode(can_out);//encodeURI(str);
d120 1
a120 1
  var pct = `hour=${hour}|txt=${dropnl_encb64(rec)}|db=${fdb}|dt=${day}`;
@


1.9
log
@feat: drop useless button and view blog random
@
text
@d99 1
d101 1
a101 1
    var req = "/tmrec.cgi/read?db="+fdb[0]+"&dt="+curDay();
a103 1
    var day = getElemValue("eNow");
d116 1
a116 1
function saveRec(fdb, day){
d120 2
a121 3
  var pct = "hour="+hour+"|txt="+dropnl_encb64(rec);
  httpPost("/tmrec.cgi/edit?db="+fdb+"&dt="+day,
    pct, HandleDone );
d124 1
a124 1
function saveBlog(fdb, day) {
d140 1
a140 1
    saveRec(er[0], day);
d150 1
a150 1
        saveBlog(er[0], day);
d216 2
a217 1
  var iswant = confirm("Do you really want to delete");
d219 1
a219 2
    var fdb = sepraDB();
    httpGet("/digest/removeDay/"+fdb[0]+"/"+fdb[1]+"/"+day,
@


1.8
log
@fix: append a useless arg in query_string
@
text
@d225 1
a225 1
/// find with page as offset
d237 1
d244 1
a244 1
  httpGet("/digest/blogIdx/"+fdb[0]+"/"+g_off,
d258 1
a258 1
  if (fn == '') {alert("must input pic name!"); return;}
d264 1
a264 1
    httpPost("/pic/upload", param, HandleUpPic)
a277 3
  } else if(item=="WITHPAGE"){
    var page = getElemValue("eDay");
    queryBlogTmKwd(page);
d292 1
a292 1
function get_dahua_stock(){
@


1.7
log
@fix: optimise layout of html and common.js
@
text
@d109 1
a109 1
    httpPost("/tmrec.cgi/blread", 'dt='+day,
d228 1
a228 1
  httpGet("/tmrec.cgi/keyword?kwd="+dropnl_encb64(kwd), HandleStdout);
@


1.6
log
@fix: all tmrec with db
@
text
@d109 1
a109 1
    httpPost("/blog.cgi/read?dt="+day, 'dt='+day,
a113 10
/// tmrec today
function getDone(){
  var fdb = sepraDB();
  if(fdb[1]=='tmrec'){
    httpGet("/tmrec.cgi/read?db="+fdb[0]+"&dt="+curDay(), HandleDone);
  }else{
    showHint('Choose is not Tmrec!');
  }
}

d129 1
a129 1
  httpPost("/blog.cgi/edit?dt="+day, pct, HandleHint );
d136 2
a137 1
function uploadDB(){
d176 1
a176 1
function recentDigest() {
d186 1
a186 1
      httpPost("/blog.cgi/title?page="+page, '', HandleBlst);
d228 1
a228 1
  httpGet("/blog.cgi/keyword?kwd="+dropnl_encb64(kwd), HandleStdout);
@


1.5
log
@feat: tmrec add db
@
text
@d100 2
a101 1
    httpGet("/tmrec.cgi/read?db="+fdb[0]+"&dt="+curDay(), HandleEditTm);
d114 1
d118 1
a118 1
    httpGet("/tmrec.cgi/read?dt="+curDay(), HandleDone);
d216 1
a216 1
    httpPost("/tmrec.cgi/read?dt="+yearmon, '', HandleStdout);
@


1.4
log
@fix: remove limit to edit tmrec
@
text
@d100 1
a100 1
    httpGet("/tmrec.cgi/read?dt="+curDay(), HandleEditTm);
a126 4
  if(hour==false){
    showHint('Up fail, hour is wrong!');
    return;
  }
d129 1
a129 1
  httpPost("/tmrec.cgi/edit?dt="+day,
d302 1
a302 1
  httpPost("/stock.cgi", '', HandleDone );
@


1.3
log
@fix: use self host default
@
text
@d49 2
a50 2
  // tmrec startwith "221001", so skip first 6 char
  txt.value = trimFirstLF(response).substring(6)
a99 6
    var d = getElemValue('eTag');
    d = tag2hour(d);
    if(d==false){
      showHint('Get tmrec fail, hour is wrong!');
      return;
    }
@


1.2
log
@fix: edit blog with tag
@
text
@d114 1
a114 1
    httpPost("/blog.cgi/read?dt="+day, '',
@


1.1
log
@feat: change url by WURL menu
@
text
@d59 2
a60 3
  //etg.value = tag;
  //var ctx = response.slice(st+1);
  var ctx = response
@

