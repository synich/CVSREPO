head	1.9;
access;
symbols;
locks; strict;
comment	@# @;


1.9
date	2022.11.20.06.45.43;	author u0_a111;	state Exp;
branches;
next	1.8;
commitid	1006379CD1729FE8A84;

1.8
date	2022.11.12.07.14.05;	author games;	state Exp;
branches;
next	1.7;

1.7
date	2022.11.12.06.21.05;	author alarm;	state Exp;
branches;
next	1.6;

1.6
date	2022.11.07.16.24.43;	author alarm;	state Exp;
branches;
next	1.5;

1.5
date	2022.11.01.16.09.42;	author u0_a111;	state Exp;
branches;
next	1.4;
commitid	100636144C653E484F2;

1.4
date	2022.10.23.06.45.23;	author u0_a111;	state Exp;
branches;
next	1.3;
commitid	1006354E3033F510A91;

1.3
date	2022.10.03.09.42.04;	author u0_a111;	state Exp;
branches;
next	1.2;
commitid	100633AAE6C319048A0;

1.2
date	2022.10.02.14.21.38;	author u0_a111;	state Exp;
branches;
next	1.1;
commitid	10063399E721FE59B39;

1.1
date	2022.09.29.16.12.00;	author u0_a111;	state Exp;
branches;
next	;
commitid	1006335C3D00A0DEA03;


desc
@@


1.9
log
@adapt lua5.1 and more hint when not found
@
text
@-- blog.cgi/read?dt=220204
local function read(q)
  local dt = q["dt"]
  local belong = dt:sub(1,1)
  local fd = io.open("../pub/b"..belong.."/"..dt..".md", "r")
  if fd then
    local txt = fd:read("*a")
    print(txt)
  else
    print(dt, " not exists")
  end
end

local function keyword(q)
  local kwd = b64dec(q["kwd"])
  local arr = str_split(kwd, " ")
  local cmd = format("select date, substr(content, 1, 50) from blog where content like '%$%' ", "$", arr[1])
  local i = 2
  if i <= #arr then
    cmd = cmd .. format("and content like '%$%' ", "$", arr[i])
    i = i + 1
  end
  cmd = cmd ..";"
  local ans = sql_exec("../pub/shuw", cmd)
  print(ans)
end

local function edit(q, c)
  local dt = q["dt"]
  local belong = dt:sub(1,1)
  local ctx = b64dec(c["ctx"])
  local fd = io.open("../pub/b"..belong.."/"..dt..".md", "w")
  fd:write(ctx)
  fd:close()
  os.execute(format("echo $ >>../pub/blog_up", "$", dt))
  print("len:"..#ctx)
end

local function title(q)
  local p = tonumber(q["page"])
  local s,e = p*50+1, p*50+50
  local cmd = "cat ../pub/blog_title | sed -ne '"..tostring(s)..","..tostring(e).."p'"
  os.execute(cmd)
end

fn["read"]=read
fn["keyword"]=keyword
fn["edit"]=edit
fn["title"]=title
fn["nedit"]=nedit
--read({dt="220115"})

local function nedit(q, c)
  local dt = q["dt"]
  local txt = c["txt"]
  local sql = format("INSERT OR REPLACE INTO blog VALUES($, '$', '$')", "$", dt, txt, "lang")
  print(sql_exec("shuw", sql))
end

@


1.8
log
@mv db to pub
@
text
@d9 2
@


1.7
log
@record updated blog
@
text
@d22 1
a22 1
  local ans = sql_exec("shuw", cmd)
d33 1
a33 1
  os.execute(format("echo $ >>upblog", "$", dt))
@


1.6
log
@query blog use sqlite
@
text
@a28 1
  print()
d33 1
@


1.5
log
@guard and local
@
text
@d14 10
a23 1
  os.execute("grep -i '"..kwd.."' ../pub/b*/*.md")
@


1.4
log
@use pub instead of Archive
@
text
@d2 1
a2 1
function read(q)
d12 1
a12 1
function keyword(q)
d14 1
a14 1
  os.execute("grep '"..kwd.."' ../pub/b*/*.md")
d17 1
a17 1
function edit(q, c)
d28 1
a28 1
function title(q)
d39 1
d42 7
@


1.3
log
@edit blog
@
text
@d5 1
a5 1
  local fd = io.open("../Archive/b"..belong.."/"..dt..".md", "r")
d14 1
a14 1
  os.execute("grep '"..kwd.."' ../Archive/b*/*.md")
d22 1
a22 1
  local fd = io.open("../Archive/b"..belong.."/"..dt..".md", "w")
d31 1
a31 1
  local cmd = "cat ../Archive/blog_title | sed -ne '"..tostring(s)..","..tostring(e).."p'"
@


1.2
log
@blog show recent
@
text
@d17 11
d37 1
@


1.1
log
@lua cgi-bin
@
text
@d4 2
a5 1
  local fd = io.open("../Archive/"..dt..".md", "r")
d14 8
a21 1
  os.execute("grep '"..kwd.."' ../Archive/*.md")
d26 1
@

